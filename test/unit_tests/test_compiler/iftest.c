#include "iftest.h"
#include "yats.h"

SETUP_YATS();


static void test_if() {
	unsigned char expected[] = {
		0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x2B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_LLOAD, 0x00,
		O_BRF_8,
		0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = true; if x { echo true; };");
}

static void test_ifelse() {
	unsigned char expected[] = {
		0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x3A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_LLOAD, 0x00,
		O_BRF_8,
		0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_BR_8,
		0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_F,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = true; if x { echo true; } else { echo false; };");
}

static void test_ifelseelseif() {
	unsigned char expected[] = {
		0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x3A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_LLOAD, 0x00,
		O_BRF_8,
		0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_BR_8,
		0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_NCONST,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = true; if x { echo true; } elseif false { echo false; } else { echo undef; };");
}

static void test_if_fold_true() {
	unsigned char expected[] = {
		0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_STRINGIFY, 0x00, 0x00,
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "if true { echo true; };");
}

static void test_ifelse_fold_true() {
	unsigned char expected[] = {
		0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "if true { echo true; } else { echo false; };");
}

static void test_ifelseelseif_fold_true() {
	unsigned char expected[] = {
		0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "if true { echo true; } elseif false { echo false; } else { echo undef; };");
}

static void test_if_fold_false() {
	unsigned char expected[] = {
		0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x19, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "if false { echo true; };");
}

static void test_ifelse_fold_false() {
	unsigned char expected[] = {
		0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_F,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "if false { echo true; } else { echo false; };");
}

static void test_ifelseelseif_fold_false() {
	unsigned char expected[] = {
		0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_F,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "if false { echo true; } elseif true { echo false; } else { echo undef; };");
}

TEST(iftest) {
	test_if();
	test_ifelse();
	test_ifelseelseif();
	test_if_fold_true();
	test_ifelse_fold_true();
	test_ifelseelseif_fold_true();
	test_if_fold_false();
	test_ifelse_fold_false();
	test_ifelseelseif_fold_false();

	return NUM_FAILED;
}
