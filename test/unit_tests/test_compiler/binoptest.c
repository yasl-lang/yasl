#include "binoptest.h"
#include "yats.h"

SETUP_YATS();

static void test_mul() {
	unsigned char expected[] = {
		0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 2,
		C_INT_1, 3,
		O_LIT, 0x00,
		O_LLOAD, 0x00,
		O_LIT, 0x01,
		O_MUL,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = 2; x * 3;");
}

static void test_fdiv() {
	unsigned char expected[] = {
		0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_FLOAT,
		0x0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0x3F,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, 0x00,
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "echo 3 / 2;");
}

static void test_idiv() {
	unsigned char expected[] = {
		0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x03,
		C_INT_1, 0x02,
		O_LIT, 0x00,
		O_LLOAD, 0x00,
		O_LIT, 0x01,
		O_IDIV,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = 3; x // 2;");
}

static void test_mod() {
	unsigned char expected[] = {
		0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x05,
		C_INT_1, 0x03,
		O_LIT, 0x00,
		O_LLOAD, 0x00,
		O_LIT, 0x01,
		O_MOD,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = 5; x % 3;");
}

static void test_add() {
	unsigned char expected[] = {
		0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x23, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x05,
		O_LIT, 0x00,
		O_LLOAD, 0x00,
		O_LIT, 0x00,
		O_ADD,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = 5; x + 5;");
}

static void test_sub() {
	unsigned char expected[] = {
		0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x05,
		C_INT_1, 0x03,
		O_LIT, 0x00,
		O_LLOAD, 0x00,
		O_LIT, 0x01,
		O_SUB,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = 5; x - 3;");
}

static void test_bshl() {
	unsigned char expected[] = {
		0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x02,
		C_INT_1, 0x03,
		O_LIT, 0x00,
		O_LLOAD, 0x00,
		O_LIT, 0x01,
		O_BSL,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = 2; x << 3;");
}

static void test_bshr() {
	unsigned char expected[] = {
		0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x08,
		C_INT_1, 0x02,
		O_LIT, 0x00,
		O_LLOAD, 0x00,
		O_LIT, 0x01,
		O_BSR,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = 8; x >> 2;");
}

static void test_band() {
	unsigned char expected[] = {
		0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x08,
		C_INT_1, 0x02,
		O_LIT, 0x00,
		O_LLOAD, 0x00,
		O_LIT, 0x01,
		O_BAND,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = 8; x & 2;");
}

static void test_bandnot() {
	unsigned char expected[] = {
		0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x08,
		C_INT_1, 0x02,
		O_LIT, 0x00,
		O_LLOAD, 0x00,
		O_LIT, 0x01,
		O_BANDNOT,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = 8; x &^ 2;");
}

static void test_bxor() {
	unsigned char expected[] = {
		0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x08,
		C_INT_1, 0x02,
		O_LIT, 0x00,
		O_LLOAD, 0x00,
		O_LIT, 0x01,
		O_BXOR,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = 8; x ^ 2;");
}

static void test_bor() {
	unsigned char expected[] = {
		0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x08,
		C_INT_1, 0x02,
		O_LIT, 0x00,
		O_LLOAD, 0x00,
		O_LIT, 0x01,
		O_BOR,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = 8; x | 2;");
}

static void test_concat() {
	unsigned char expected[] = {
		0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x23, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 2,
		C_INT_1, 1,
		O_LIT, 0x00,
		O_LIT, 0x01,
		O_CNCT,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "2 ~ 1;");
}

static void test_and() {
	unsigned char expected[] = {
		0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x27, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_DUP,
		O_BRF_8,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_POP,
		O_BCONST_F,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "true && false;");
}

static void test_or() {
	unsigned char expected[] = {
		0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x27, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_T,
		O_DUP,
		O_BRT_8,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_POP,
		O_BCONST_F,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "true || false;");
}

TEST(binoptest) {
	test_mul();
	test_fdiv();
	test_idiv();
	test_mod();
	test_add();
	test_sub();
	test_bshl();
	test_bshr();
	test_band();
	test_bandnot();
	test_bxor();
	test_bor();
	test_concat();
	test_and();
	test_or();

	return NUM_FAILED;
}
