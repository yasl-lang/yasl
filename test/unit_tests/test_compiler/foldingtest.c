#include "unoptest.h"
#include "yats.h"

SETUP_YATS();

static void test_neg() {
	unsigned char expected[] = {
		0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0xF0,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "echo -16;");
}

static void test_not() {
	unsigned char expected[] = {
		0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_BCONST_F,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "echo !true;");
}

static void test_bnot() {
	unsigned char expected[] = {
		0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0xFF,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "echo ^0x00;");
}

static void test_mul() {
	unsigned char expected[] = {
		0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0X22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x06,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "echo 2 * 3;");
}

static void test_idiv() {
	unsigned char expected[] = {
		0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x01,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "echo 3 // 2;");
}

static void test_mod() {
	unsigned char expected[] = {
		0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x02,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "echo 5 % 3;");
}

static void test_add() {
	unsigned char expected[] = {
		0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x0B,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "echo 6 + 5;");
}

static void test_sub() {
	unsigned char expected[] = {
		0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x05,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "echo 8 - 3;");
}

static void test_bshl() {
	unsigned char expected[] = {
		0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x10,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "echo 2 << 3;");
}

static void test_bshr() {
	unsigned char expected[] = {
		0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x02,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected,"echo 8 >> 2;");
}

static void test_band() {
	unsigned char expected[] = {
		0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x08,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected,"echo 8 & 10;");
}

static void test_bandnot() {
	unsigned char expected[] = {
		0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x02,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected,"echo 2 &^ 12;");
}

static void test_bxor() {
	unsigned char expected[] = {
		0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x0A,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected,"echo 8 ^ 2;");
}

static void test_bor() {
	unsigned char expected[] = {
		0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0x0A,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "echo 8 | 2;");
}

static void test_fneg() {
	unsigned char expected[] = {
		0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_FLOAT,
		0x9A, 0x99, 0x99, 0x99, 0x99, 0x99, 0xF9, 0xBF,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "echo -1.6;");
}

static void test_fmul() {
	unsigned char expected[] = {
		0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_FLOAT,
		0xAF, 0x47, 0xE1, 0x7A, 0x14, 0xAE, 0x1F, 0x40,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "echo 2.2 * 3.6;");
}

static void test_fdiv() {
	unsigned char expected[] = {
		0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_FLOAT,
		0xCD, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xFC, 0x3F,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "echo 3.6 / 2.0;");
}

static void test_fadd() {
	unsigned char expected[] = {
		0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_FLOAT,
		0x9A, 0x99, 0x99, 0x99, 0x99, 0x99, 0x15, 0x40,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "echo 2.1 + 3.3;");
}

static void test_fsub() {
	unsigned char expected[] = {
		0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_FLOAT,
		0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0xF6, 0xBF,
		O_LIT, 0x00,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "echo 2.2 - 3.6;");
}

TEST(foldingtest) {
	test_neg();
	test_not();
	test_bnot();

	test_mul();
	test_idiv();
	test_mod();
	test_add();
	test_sub();
	test_bshl();
	test_bshr();
	test_band();
	test_bandnot();
	test_bxor();
	test_bor();

	test_fneg();
	test_fmul();
	test_fdiv();
	test_fadd();
	test_fsub();

	return NUM_FAILED;
}
