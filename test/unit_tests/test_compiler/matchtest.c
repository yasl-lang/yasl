#include "yats.h"
#include "matchtest.h"

SETUP_YATS();

static void test_simple() {
	unsigned char expected[] = {
		0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 1,
		C_STR,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'o', 'n', 'e',
		C_STR,
		0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'n', 'o', 't', ' ', 'o', 'n', 'e',
		O_LIT, 0x00,
		O_LLOAD, 0x00,
		O_COLLECT_REST, 0x01,
		/* first pattern */
		O_MATCH,
		0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_LIT, 0x00,
		O_POP,
		O_LIT, 0x01,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_BR_8,
		0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* second pattern */
		O_MATCH,
		0x13, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_ONE,
		O_POP,
		O_LIT, 0x02,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_BR_8,
		0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_MATCH,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_ANY,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = 1; match x { 1 { echo 'one'; }; * { echo 'not one'; }; };");
}

static void test_list() {
	unsigned char expected[] = {
		0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0xAA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 2,
		C_INT_1, 1,
		C_STR,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'v', 'a', 'r',
		O_END,
		O_NEWLIST,
		O_LLOAD, 0x00,
		O_COLLECT_REST, 0x01,
		/* first pattern */
		O_MATCH,
		0x1D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_LS,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_ONE,
		P_ONE,
		O_POP,
		O_LIT, 0x00,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_BR_8,
		0x55, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* second pattern */
		O_MATCH,
		0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_LS,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_ONE,
		O_POP,
		O_LIT, 0x01,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_BR_8,
		0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* third pattern */
		O_MATCH,
		0x1B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_VLS,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_POP,
		O_LIT, 0x02,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_BR_8,
		0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_MATCH,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_ANY,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = []; match x { [ *, * ] { echo 2; }; [ * ] { echo 1; }; [ ... ] { echo 'var'; }; };");
}

static void test_table() {
	unsigned char expected[] = {
		0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0xC4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_STR,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'x',
		C_STR,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'y',
		C_INT_1, 2,
		C_INT_1, 1,
		C_STR,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'v', 'a', 'r',
		O_END,
		O_NEWTABLE,
		O_LLOAD, 0x00,
		O_COLLECT_REST, 0x01,
		/* first pattern */
		O_MATCH,
		0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_TABLE,
		0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_LIT, 0x00,
		P_ONE,
		P_LIT, 0x01,
		P_ONE,
		O_POP,
		O_LIT, 0x02,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_BR_8,
		0x57, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* second pattern */
		O_MATCH,
		0x1E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_TABLE,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_LIT, 0x00,
		P_ONE,
		O_POP,
		O_LIT, 0x03,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_BR_8,
		0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* third pattern */
		O_MATCH,
		0x1B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_VTABLE,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_POP,
		O_LIT, 0x04,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_BR_8,
		0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_MATCH,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_ANY,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = {}; match x { { .x: *, .y: * } { echo 2; }; { .x: * } { echo 1; }; { ... } { echo 'var'; }; };");
}

static void test_bind() {
	unsigned char expected[] = {
		0x26, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 1,
		C_STR,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'o', 'n', 'e',
		O_LIT, 0x00,
		O_LLOAD, 0x00,
		O_COLLECT_REST, 0x01,
		/* first pattern */
		O_MATCH,
		0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_LIT, 0x00,
		O_POP,
		O_LIT, 0x01,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_BR_8,
		0x2E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* second pattern */
		O_MATCH,
		0x19, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_BIND, 0x01,
		O_INCSP, 0x01,
		O_DEL_FP, 0x01,
		O_LLOAD, 0x01,
		O_STRINGIFY, 0x02, '\0',
		O_ECHO, 0x02,
		O_DECSP, 0x01,
		O_BR_8,
		0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_MATCH,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_ANY,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = 1; match x { 1 { echo 'one'; }; let x { echo x; }; };");
}

static void test_bind_list() {
	unsigned char expected[] = {
		0x26, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x81, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 1,
		C_STR,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'o', 'n', 'e',
		O_END,
		O_LIT, 0x00,
		O_NEWLIST,
		O_COLLECT_REST, 0x00,
		/* first pattern */
		O_MATCH,
		0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_LIT, 0x00,
		O_POP,
		O_LIT, 0x01,
		O_STRINGIFY, 0x00, '\0',
		O_ECHO, 0x00,
		O_BR_8,
		0x37, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* second pattern */
		O_MATCH,
		0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_LS,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_BIND, 0x00,
		O_INCSP, 0x01,
		O_DEL_FP, 0x00,
		O_LLOAD, 0x00,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_DECSP, 0x01,
		O_BR_8,
		0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_MATCH,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_ANY,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "match [ 1 ] { 1 { echo 'one'; }; [ let x ] { echo x; }; };");
}

static void test_guard_simple() {
	unsigned char expected[] = {
		0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x92, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 1,
		C_STR,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'o', 'n', 'e',
		C_INT_1, 10,
		C_STR,
		0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'n', 'o', 't', ' ', 'o', 'n', 'e',
		O_LIT, 0x00,
		O_LLOAD, 0x00,
		O_COLLECT_REST, 0x01,
		/* first pattern */
		O_MATCH,
		0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_LIT, 0x00,
		O_POP,
		O_LIT, 0x01,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_BR_8,
		0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* second pattern */
		O_MATCH,
		0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_ONE,
		O_LLOAD, 0x00,
		O_LIT, 0x02,
		O_GT,
		O_BRF_8,
		0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_POP,
		O_LIT, 0x03,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_BR_8,
		0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_MATCH,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_ANY,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = 1; match x { 1 { echo 'one'; }; * if x > 10 { echo 'not one'; }; };");
}

static void test_guard_list() {
	unsigned char expected[] = {
		0x3A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0xA4 REG_OPT(+1), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 0,
		C_STR,
		0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'n', 'o', 'n', '-', 'e', 'm', 'p', 't', 'y',
		C_STR,
		0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'e', 'm', 'p', 't', 'y',
		O_END,
		O_NEWLIST,
		O_LLOAD, 0x00,
		O_COLLECT_REST, 0x01,
		/* first pattern */
		O_MATCH,
		0x2A REG_OPT(+1), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_VLS,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_LLOAD, 0x00,
		O_LEN, REG_OPT(0x02,)
		O_LIT, 0x00,
		O_GT,
		O_BRF_8,
		0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_POP,
		O_LIT, 0x01,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_BR_8,
		0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* second pattern */
		O_MATCH,
		0x1B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_LS,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_POP,
		O_LIT, 0x02,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_BR_8,
		0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_MATCH,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_ANY,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = []; match x { [ ... ] if len x > 0 { echo 'non-empty'; }; [] { echo 'empty'; }; };");
}

static void test_guard_bind() {
	unsigned char expected[] = {
		0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0xBB, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		C_INT_1, 1,
		C_INT_1, 2,
		C_INT_1, 0,
		C_STR,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'p', 'o', 's',
		C_STR,
		0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		'o', 't', 'h', 'e', 'r',
		O_END,
		O_LIT, 0x00,
		O_LIT, 0x01,
		O_NEWLIST,
		O_LLOAD, 0x00,
		O_COLLECT_REST, 0x01,
		/* first pattern */
		O_MATCH,
		0x47, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_LS,
		0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		P_BIND, 0x01,
		P_BIND, 0x02,
		O_INCSP, 0x02,
		O_MOVEUP_FP, 0x01,
		O_LLOAD, 0x01,
		O_LIT, 0x02,
		O_GT,
		O_DUP,
		O_BRF_8,
		0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_POP,
		O_LLOAD, 0x02,
		O_LIT, 0x02,
		O_GT,
		O_BRF_8,
		0x13, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_POP,
		O_LIT, 0x03,
		O_STRINGIFY, 0x03, '\0',
		O_ECHO, 0x03,
		O_DECSP, 0x02,
		O_BR_8,
		0x2C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_MOVEDOWN_FP, 0x01,
		O_POP, O_POP,
		/* second pattern */
		O_MATCH,
		0x13, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_ONE,
		O_POP,
		O_LIT, 0x04,
		O_STRINGIFY, 0x01, '\0',
		O_ECHO, 0x01,
		O_BR_8,
		0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		O_MATCH,
		0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x01, P_ANY,
		O_POP,
		O_HALT
	};
	ASSERT_GEN_BC_EQ(expected, "let x = [ 1, 2 ]; match x { [ const a, const b ] if a > 0 && b > 0 { echo 'pos'; }; * { echo 'other'; }; };");
}

TEST(matchtest) {
	test_simple();
	test_list();
	test_table();
	test_bind();
	test_bind_list();

	test_guard_simple();
	test_guard_list();
	test_guard_bind();

	return NUM_FAILED;
}
